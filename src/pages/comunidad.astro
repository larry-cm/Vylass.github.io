---
import Layout from "@/layouts/Layout.astro";
import Cards from "@/components/Cards.astro";
import { IconFacebook, IconGitHub, IconInstagram } from "@/assets/Icons";
import FormPost from "@/components/FormPost";
import { turso } from "@/utils/configTurso";
import ButtonStart from "@/assets/ButtonStart.astro";
import ButtonMenu from "@/components/ButtonMenu";

const { redirectToSignIn } = Astro.locals.auth();
const user = await Astro.locals.currentUser();
if (!user) return redirectToSignIn();

const { firstName, lastName, id, hasImage, imageUrl, primaryEmailAddress } =
    user;

await turso.execute(
    "INSERT OR IGNORE INTO users (user_id, user_name, user_email, user_url) VALUES (?, ?, ?, ?)",
    [
        id,
        `${firstName || ""} ${lastName || ""}`,
        primaryEmailAddress?.emailAddress || "",
        hasImage ? imageUrl : import.meta.env.SECRET_IMG_DEFAULT,
    ],
);
const posts = Astro.locals.posts;
---

<Layout title="üîê Pagina privada || MySQL || FetchToMySQL">
    <header class="relative block w-full my-16 space-y-4 h-fit">
        <h2 class="text-2xl font-bold text-white text-balance sm:text-4xl">
            Bienvenido {firstName || ""}, Crea y comparte publicaciones entre
            desarrolladores.
        </h2>
        <p
            class="text-base font-normal sm:text-xl text-slate-200 dark:text-slate-300"
        >
            Es esta parte de la comunidad, es donde podras compartir tus
            proyectos, ideas y experiencias.
        </p>
    </header>
    <div
        class="flex flex-col sm:flex-row gap-4 mb-4 sm:h-[780px] overflow-hidden sm:overflow-auto"
    >
        <section
            class="flex flex-col items-center gap-4 h-full relative sm:sticky top-0"
            role="form"
            aria-label="Formulario para crear una publicacion"
        >
            <!-- cuadro para publicar -->
            <FormPost
                client:load
                userId={id}
                imageUrl={imageUrl || ""}
                firstName={firstName || ""}
            />
            <!-- aviso -->
            <article
                class="sm:order-2 order-1 h-full bg-neutral-900/80 p-4 rounded-md sm:max-w-xs shadow-2xl"
            >
                <h2 class="text-lg font-medium">
                    Estoy trabajando en esta parte para la comunidad
                </h2>
                <p class="font-light mt-[1lh]">
                    Somos un grupo peque√±o conformado por una sola persona por
                    el momento.
                </p>
                <p class="font-light mt-[1lh]">
                    Pero estoy aceptando colaboracion, me gustaria mucho
                    trabajar en grupo ya que principal mente practico solo.
                </p>
                <div class="font-medium mt-[1lh] flex flex-col justify-between">
                    <strong class="font-medium">Contacto</strong>
                    <div class="flex gap-5 mt-4">
                        <a
                            target="_blank"
                            href="https://www.facebook.com/profile.php?id=100063723084114"
                            class="p-2 transition rounded cursor-pointer bg-neutral-800/80 opacity-90 group hover:opacity-100 hover:bg-neutral-800"
                            ><IconFacebook
                                className="size-6 max-w-6 group-hover:scale-110 transition duration-300 group-hover:text-orange-500"
                            /></a
                        >
                        <a
                            target="_blank"
                            href="https://github.com/larry-cm"
                            class="p-2 transition rounded cursor-pointer bg-neutral-800/80 opacity-90 group hover:opacity-100 hover:bg-neutral-800"
                            ><IconGitHub
                                className="size-6 max-w-6 group-hover:scale-110 transition duration-300 group-hover:text-orange-500"
                            /></a
                        >
                        <a
                            target="_blank"
                            href="https://www.instagram.com/sonia.ceballo.503/"
                            class="p-2 transition rounded cursor-pointer bg-neutral-800/80 opacity-90 group hover:opacity-100 hover:bg-neutral-800"
                            ><IconInstagram
                                className="size-6 max-w-6 group-hover:scale-110 transition duration-300 group-hover:text-orange-500"
                            /></a
                        >
                    </div>
                </div>
            </article>
        </section>
        <!-- grid de publicaciones -->
        <section
            class="w-full grid sm:grid-cols-[repeat(auto-fill,minmax(250px,1fr))] gap-4 snap-y md:snap-none relative sm:pe-4 h-160 sm:overflow-auto overflow-hidden sm:h-full"
            aria-label="Publicaciones recientes"
            role="region"
        >
            {
                posts?.map(
                    (
                        { username, imgUrl, title, content, postDate, userUrl },
                        i,
                    ) => (
                        <Cards
                            id={id || "0"}
                            index={i}
                            imagePost={imgUrl}
                            inscripcionDate={postDate}
                            imageUser={
                                userUrl || import.meta.env.SECRET_IMG_DEFAULT
                            }
                            firstName={username}
                            title={title}
                            description={content}
                        />
                    ),
                )
            }
        </section>
    </div>
    <section class="w-full">
        <h3
            class="w-full text-3xl text-center bg-fondo p-8 rounded-md space-y-[.5lh] shadow-2xl mb-4 max-[450px]:max-w-80 mx-auto sm:max-w-full sm:mx-0"
        >
            <p class="font-semibold">¬°La aventura contin√∫a!</p>
            <p class="text-xl font-light mt-2">
                Actualmente estoy desarrollando varios proyectos emocionantes.
            </p>
            <p class="text-xl font-light mt-1">
                Te invito a explorar un adelanto de lo que viene
            </p>
        </h3>

        <div
            class="grid grid-cols-1 grid-rows-3 md:grid-cols-4 md:grid-rows-4 bg-fondo rounded w-full place-items-center gap-4 *:rounded-md *:shadow-xl max-[450px]:*:mx-auto *:mx-0 max-[450px]:*:max-w-80"
        >
            <article
                aria-label="una de mis primeras paginas webs."
                class="bg-[url(/imgs/adidas-proyect.webp)] bg-cover bg-no-repeat row-span-1 col-span-1 md:row-span-full md:col-span-2 bg-amber-500 w-full grid group cursor-pointer select-none relative min-h-150 h-full"
                role="banner"
            >
                <div
                    class="size-full bg-fondo/85 col-start-1 -col-end-1 row-start-1 -row-end-1 scale-70 group-hover:scale-100 z-0 group-hover:z-10 transition duration-200 animate-bezier-back-in opacity-0 group-hover:opacity-100 group-hover:saturate-200 backdrop-blur-xs absolute"
                >
                    <div class="p-4 flex flex-col size-full justify-between">
                        <header>
                            <menu
                                aria-label="Mini menu de las imagenes"
                                class="flex h-fit gap-5"
                            >
                                <ButtonStart />
                                <ButtonMenu client:visible />
                            </menu>
                            <h3
                                class="text-3xl font-medium text-slate-100 text-center mt-8"
                            >
                                Adidas colombia
                            </h3>
                        </header>

                        <div
                            class="space-y-[1lh] text-xl font-light group-hover:animate-blurred-fade-in duration-100"
                        >
                            <p>
                                Un proyecto desarrollado para completar un curso
                                de programacion e aumentare mis hablidades.
                            </p>
                            <p>
                                En ese momento tuve la oportunidad de colaborar
                                con otros desarrolladores aunque no fue
                                presencial fue buena experiencia.
                            </p>
                            <small
                                >Todo el dise√±o fue implementado por mi.</small
                            >
                        </div>
                    </div>
                </div>
            </article>

            <article
                class="col-span-1 md:col-span-2 row-span-1 md:row-span-2 bg-red-400 size-full"
            >
                s
            </article>
            <article
                class="col-span-1 md:col-span-2 row-span-1 md:row-span-2 size-full bg-sky-400"
            >
                s
            </article>
        </div>
    </section>
</Layout>
